---
title: Simulations for interaction method
author: Gibran Hemani
date: "`r Sys.date()`"
---


## Objective

The interaction model aims to maximise power when effects are shared, and estimate the heterogeneity when effects are distinct. Perform nested interaction model.

```{r}
library(dplyr)
library(ggplot2)

load("inst_interaction_sim1.rdata")
load("inst_interaction_sim2.rdata")
load("inst_interaction_sim3.rdata")
class(res)
dim(res)
res <- as_tibble(res)

res %>%
    mutate(diff_pval=case_when(method=="AIC" & diff_pval < -2 ~ 0, method=="AIC" & diff_pval >= -2 ~ 1, TRUE ~ diff_pval)) %>%
    filter(!is.na(diff_pval)) %>%
    filter(method != "coxtest") %>%
    group_by(npop, max_ratio, biv_sd, method) %>%
    summarise(p_diffp = sum(diff_pval < 0.05)/n()) %>%
    ggplot(., aes(x=biv_sd, y=p_diffp)) +
    geom_point(aes(colour=as.factor(method))) +
    facet_grid(npop ~ max_ratio, labeller=label_both) +
    scale_colour_brewer(type="qual") +
    theme(axis.text.x=element_text(angle=90))
```


```{r}
res2 %>%
    filter(method %in% c("FE meta analysis", "nested anova"), pop=="all") %>%
    group_by(method, biv_sd, biv_m, npop, max_ratio) %>%
    summarise(pow=sum(pval < 0.05)/n(), bias=mean(b-biv_m), mse=mean((b-biv_m)^2)) %>%
    ggplot(., aes(x=biv_m, y=pow)) +
        geom_point(aes(colour=method, shape=as.factor(biv_sd))) +
        geom_line(aes(colour=method, linetype=as.factor(biv_sd))) +
        facet_grid(npop ~ max_ratio, labeller=label_both) +
        scale_colour_brewer(type="qual") +
        theme(axis.text.x=element_text(angle=90))

res2 %>%
    filter(method %in% c("FE meta analysis", "nested anova"), pop=="all") %>%
    group_by(method, biv_sd, biv_m, npop, max_ratio) %>%
    summarise(pow=sum(pval < 0.05)/n(), bias=mean(b-biv_m), mse=mean((b-biv_m)^2)) %>%
    ggplot(., aes(x=biv_m, y=bias)) +
        geom_point(aes(colour=method, shape=as.factor(biv_sd))) +
        geom_line(aes(colour=method, linetype=as.factor(biv_sd))) +
        facet_grid(npop ~ max_ratio, labeller=label_both) +
        scale_colour_brewer(type="qual") +
        theme(axis.text.x=element_text(angle=90))

res2 %>%
    filter(method %in% c("FE meta analysis", "nested anova"), pop=="all") %>%
    group_by(method, biv_sd, biv_m, npop, max_ratio) %>%
    summarise(pow=sum(pval < 0.05)/n(), bias=mean(b-biv_m), mse=mean((b-biv_m)^2)) %>%
    ggplot(., aes(x=biv_m, y=mse)) +
        geom_point(aes(colour=method, shape=as.factor(biv_sd))) +
        geom_line(aes(colour=method, linetype=as.factor(biv_sd))) +
        facet_grid(npop ~ max_ratio, labeller=label_both) +
        scale_colour_brewer(type="qual") +
        theme(axis.text.x=element_text(angle=90))


res2 %>%
    filter(method %in% c("FE meta analysis"), pop=="all", biv_sd==0) %>%
    group_by(method, biv_sd, biv_m, npop, max_ratio) %>%
    summarise(pow=sum(pval < 0.05)/n(), bias=mean(b-biv_m), mse=mean((b-biv_m)^2)) %>%
    ggplot(., aes(x=biv_m, y=bias)) +
        geom_point(aes(colour=as.factor(npop))) +
        geom_line(aes(colour=as.factor(npop))) +
        facet_grid(max_ratio ~ ., labeller=label_both) +
        scale_colour_brewer() +
        theme(axis.text.x=element_text(angle=90))

```

```{r}
res3 %>%
    filter(method %in% c("FE meta analysis"), pop=="all", biv_sd==0, biv_m==0) %>%
    group_by(method, biv_sd, biv_m, npop, max_ratio) %>%
    summarise(pow=sum(pval < 0.05)/n(), bias=mean(b-biv_m), mse=mean((b-biv_m)^2)) %>%
    ggplot(., aes(x=npop, y=pow)) +
        geom_point() +
        geom_line() +
        facet_grid(max_ratio ~ ., labeller=label_both) +
        scale_colour_brewer() +
        theme(axis.text.x=element_text(angle=90))
```

```{r}
res3 %>%
    filter(method %in% c("FE meta analysis"), pop=="all", biv_sd==0, biv_m==0) %>%
    group_by(method, biv_sd, biv_m, npop, max_ratio) %>%
    summarise(pow=sum(pval < 0.05)/n(), bias=mean(b-biv_m), mse=mean((b-biv_m)^2)) %>%
    ggplot(., aes(x=npop, y=bias)) +
        geom_point() +
        geom_line() +
        facet_grid(max_ratio ~ ., labeller=label_both) +
        scale_colour_brewer() +
        theme(axis.text.x=element_text(angle=90))

```


```{r}
res3 %>%
    filter(method %in% c("FE meta analysis"), pop=="all", biv_sd==0) %>%
    group_by(method, biv_sd, biv_m, npop, max_ratio) %>%
    mutate(bias=(b-biv_m)^2) %>%
    {summary(lm(bias ~ npop + max_ratio, .))}
```

```{r}
res3 %>%
    filter(method %in% c("FE meta analysis"), pop=="all", biv_sd==0) %>%
    group_by(method, biv_sd, biv_m, npop, max_ratio) %>%
    mutate(pow=sum(pval < 0.05)/n(), bias=(b-biv_m)^2) %>%
    {summary(lm(pow ~ npop + max_ratio, .))}
```

Summary

- Larger number of populations improves ability to estimate heterogeneity
- 
