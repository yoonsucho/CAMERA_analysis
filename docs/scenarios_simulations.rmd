---
title: Simulating across various scenarios
---

## Background

- Scenario 1: Use EUR discovery bgx for all ancestries
- Scenario 2: Use EUR discovery SNP, re-estimate bgx in all ancestries
- Scenario 3: Use meta analysis bgx to discovery SNP, re-estimate in all ancestries



```{r}
library(simulateGP)
library(dplyr)
library(data.table)
library(here)
library(TwoSampleMR)
library(furrr)
library(parallel)
```



```{r}
organise_ldobj <- function(dirs, region)
{
  ld <- lapply(dirs, \(x) readRDS(file.path(x, paste0("ldobj_", region, ".rds"))))
  x1 <- unique(ld[[1]]$map$snp)
  x <- Reduce(intersect, lapply(ld, \(x) x$map$snp))[1:500]
  ld <- lapply(ld, \(y) subset_ldobj(y, x))
  names(ld) <- gsub("ld", "", basename(dirs))
  stopifnot(all(ld[[1]]$map$snp == ld[[2]]$map$snp))
  return(ld)
}


subset_ldobj <- function(ldobj, snps)
{
  i <- which(ldobj$map$snp %in% snps)
  ldobj$map <- ldobj$map[i,]
  ldobj$ld <- ldobj$ld[i,i]
  return(ldobj)
}

dirs <- here("data", "ld", c("ldAFR", "ldAMR", "ldEAS", "ldEUR", "ldSAS"))
region <- "1_83991748_84844495"
ld <- organise_ldobj(dirs, region)
str(ld)
```


```{r}
ld_fast <- function(params, nid, ld, minmaf=0.01) {
    xvar <- sqrt(2 * params[["af"]] * (1-params[["af"]]))
    params %>%
        dplyr::mutate(
            af = pmax(minmaf, af) %>% pmin(1-minmaf, 1-af),
            beta_ld = (diag(1/xvar) %*% ld %*% diag(xvar) %*% beta) %>% drop(),
            se = expected_se(beta_ld, af, nid, vy=1),
            bhat = stats::rnorm(length(beta_ld), beta_ld, se),
            fval = (bhat / se)^2,
            n = nid,
            pval = pf(fval, df1=1, df2=nid-1, lower.tail=FALSE)
        )
}


# ax1 <- ld[["EUR"]]$map %>%
#         generate_gwas_params(h2=0.001, S=0, Pi=1/nrow(.)) 

# microbenchmark(ax <- ax1 %>%
#         ld_fast(nid=nid[["EUR"]], ld=ld[["EUR"]]$ld), times=1)

# library(microbenchmark)
# microbenchmark(ax2 <- ax1 %>%
#         generate_gwas_ss(nid=nid[["EUR"]], ld=ld[["EUR"]]$ld), times=1)

# microbenchmark(ax3 <- ax1 %>%
#         generate_gwas_ss(nid=nid[["EUR"]], ld=ld[["EUR"]]$ld), times=1)

# head(ax)
# head(ax2)

# var(ax$bhat)
# var(ax2$bhat)

# cor(ax$bhat, ax2$bhat)
# cor(ax3$bhat, ax2$bhat)
# lm(ax$bhat ~ ax2$bhat)

# pdf()
# plot(ax$bhat, ax2$bhat)
```

```{r}
simss_fast <- function(ld, nid, bxy, h2=0.05) {
    ax <- ld[["EUR"]]$map %>%
        generate_gwas_params(h2=h2, S=0, Pi=1/nrow(.)) %>%
        ld_fast(nid=nid[["EUR"]], ld=ld[["EUR"]]$ld)
    ay <- ax %>% select(chr, snp, pos, alt, ref, af, beta) %>% mutate(beta=beta*bxy[["EUR"]]) %>%
        ld_fast(nid=nid[["EUR"]], ld=ld[["EUR"]]$ld)
    a <- merge(ax, ay, by=c("chr", "snp", "pos", "alt", "ref", "af"))

    pops <- names(ld)[!names(ld) %in% "EUR"]

    b <- lapply(pops, \(pop) {
        bx <- ld[[pop]]$map %>%
            mutate(beta=ax$beta) %>%
            ld_fast(nid=nid[[pop]], ld=ld[[pop]]$ld)
        by <- bx %>% select(chr, snp, pos, alt, ref, af, beta) %>% mutate(beta=beta*bxy[[pop]]) %>%
            ld_fast(nid=nid[[pop]], ld=ld[[pop]]$ld)
        b <- merge(bx, by, by=c("chr", "snp", "pos", "alt", "ref", "af"))
    })
    names(b) <- pops
    return(list(a=a, b=b))

}
```


```{r}

simss <- function(ld, nid, bxy) {
    ax <- ld[["EUR"]]$map %>%
        generate_gwas_params(h2=0.001, S=0, Pi=1/nrow(.)) %>%
        generate_gwas_ss(nid=nid[["EUR"]], ld=ld[["EUR"]]$ld)
    ay <- ax %>% select(chr, snp, pos, alt, ref, af, beta) %>% mutate(beta=beta*bxy[["EUR"]]) %>%
        generate_gwas_ss(nid=nid[["EUR"]], ld=ld[["EUR"]]$ld)
    a <- merge(ax, ay, by=c("chr", "snp", "pos", "alt", "ref", "af"))

    pops <- names(ld)[!names(ld) %in% "EUR"]

    b <- lapply(pops, \(pop) {
        bx <- ld[[pop]]$map %>%
            mutate(beta=ax$beta) %>%
            generate_gwas_ss(nid=nid[[pop]], ld=ld[[pop]]$ld)
        by <- bx %>% select(chr, snp, pos, alt, ref, af, beta) %>% mutate(beta=beta*bxy[[pop]]) %>%
            generate_gwas_ss(nid=nid[[pop]], ld=ld[[pop]]$ld)
        b <- merge(bx, by, by=c("chr", "snp", "pos", "alt", "ref", "af"))
    })
    names(b) <- pops
    return(list(a=a, b=b))
}
```

```{r}
fixed_effects_meta_analysis <- function(beta_vec, se_vec, infl=10000) {
    ind <- identify_blownup_estimates(beta_vec, se_vec, infl)
    beta_vec[ind] <- NA
    se_vec[ind] <- NA
    w <- 1 / se_vec^2
    beta <- sum(beta_vec * w, na.rm=T) / sum(w, na.rm=T)
    se <- sqrt(1 / sum(w, na.rm=T))
    pval <- pnorm(abs(beta / se), lower.tail = FALSE)
    Qj <- w * (beta-beta_vec)^2
    Q <- sum(Qj, na.rm=T)
    Qdf <- sum(!is.na(beta_vec))-1
    if(Qdf == 0) Q <- 0
    Qjpval <- pchisq(Qj, 1, lower.tail=FALSE)
    Qpval <- pchisq(Q, Qdf, lower.tail=FALSE)
    return(list(beta=beta, se=se, pval=pval, Q=Q, Qdf=Qdf, Qpval=Qpval, Qj=Qj, Qjpval=Qjpval))
}

identify_blownup_estimates <- function(b, se, infl) {
  semin <- which.min(se)
  abs(b) > infl*abs(b[semin])
}

fixed_effects_meta_analysis_fast <- function(beta_mat, se_mat) {
  w <- 1 / se_mat^2
  beta <- rowSums(beta_mat * w) / rowSums(w, na.rm=TRUE)
  se <- sqrt(1 / rowSums(w, na.rm=TRUE))
  z <- abs(beta / se)
  p <- pnorm(z, lower.tail = FALSE)
  nstudy <- apply(beta_mat, 1, \(x) sum(!is.na(x)))
  return(tibble(nstudy, p, z=z))
}

scenario1 <- function(a, b) {
    as <- a[which.min(a$pval.x),]
    mra <- mr_wald_ratio(as$bhat.x, as$bhat.y, as$se.x, as$se.y) %>% as_tibble() %>%
        mutate(pop="EUR", fstat=as$fval.x, cv=as$beta.x!=0)
        

    mrb <- lapply(names(b), \(pop) {
        bs <- subset(b[[pop]], snp == as$snp)
        mrb <- mr_wald_ratio(as$bhat.x, bs$bhat.y, as$se.x, bs$se.y) %>% as_tibble() %>%
            mutate(pop=pop, fstat=bs$fval.x, cv=bs$beta.x!=0)
        return(mrb)
    }) %>% bind_rows()


    res <- bind_rows(mra, mrb)
    q <- fixed_effects_meta_analysis(res$b, res$se)
    res$Qjpval <- q$Qjpval
    bind_rows(res, tibble(b=q$beta, se=q$se, pval=q$pval, pop="All", nsnp=1, Qjpval=q$Qpval)) %>%
        mutate(scanerio=1)
}

scenario2 <- function(a, b) {
    as <- a[which.min(a$pval.x),]
    mra <- mr_wald_ratio(as$bhat.x, as$bhat.y, as$se.x, as$se.y) %>% as_tibble() %>%
        mutate(pop="EUR", fstat=as$fval.x, cv=as$beta.x!=0)
        

    mrb <- lapply(names(b), \(pop) {
        bs <- subset(b[[pop]], snp == as$snp)
        mrb <- mr_wald_ratio(bs$bhat.x, bs$bhat.y, bs$se.x, bs$se.y) %>% as_tibble() %>%
            mutate(pop=pop, fstat=bs$fval.x, cv=bs$beta.x!=0)
        return(mrb)
    }) %>% bind_rows()


    res <- bind_rows(mra, mrb)
    q <- fixed_effects_meta_analysis(res$b, res$se)
    res$Qjpval <- q$Qjpval
    bind_rows(res, tibble(b=q$beta, se=q$se, pval=q$pval, pop="All", nsnp=1, Qjpval=q$Qpval)) %>%
        mutate(scanerio=2)
}


scenario3 <- function(a, b) {
    bmat <- cbind(a$bhat.x, lapply(b, \(x) x$bhat.x) %>% do.call(cbind, .))
    semat <- cbind(a$se.x, lapply(b, \(x) x$se.x) %>% do.call(cbind, .))
    fema <- fixed_effects_meta_analysis_fast(bmat, semat)
    which.min(fema$p)
    which.min(a$pval.x)
    snp <- which.min(fema$p)
    as <- a[snp,]
    mra <- mr_wald_ratio(as$bhat.x, as$bhat.y, as$se.x, as$se.y) %>% as_tibble() %>%
        mutate(pop="EUR", fstat=as$fval.x, cv=as$beta.x!=0)
        

    mrb <- lapply(names(b), \(pop) {
        bs <- subset(b[[pop]], snp == as$snp)
        mrb <- mr_wald_ratio(bs$bhat.x, bs$bhat.y, bs$se.x, bs$se.y) %>% as_tibble() %>%
            mutate(pop=pop, fstat=bs$fval.x, cv=bs$beta.x!=0)
        return(mrb)
    }) %>% bind_rows()


    res <- bind_rows(mra, mrb)
    q <- fixed_effects_meta_analysis(res$b, res$se)
    res$Qjpval <- q$Qjpval
    bind_rows(res, tibble(b=q$beta, se=q$se, pval=q$pval, pop="All", nsnp=1, Qjpval=q$Qpval)) %>%
        mutate(scanerio=3)
}
```

```{r}
nid <- list(EUR=1000000, AFR=100000, AMR=100000, EAS=100000, SAS=100000)
bxy <- list(EUR=0.3, AFR=0.3, AMR=0.3, EAS=0.3, SAS=0.3)
o3 <- simss_fast(ld, nid, bxy)

bxy <- list(EUR=0.3, AFR=0.3, AMR=0.3, EAS=0.3, SAS=-0.3)
o3h <- simss_fast(ld, nid, bxy)

scenario1(o3$a, o3$b)
scenario2(o3$a, o3$b)
scenario3(o3$a, o3$b)

scenario1(o3h$a, o3h$b)
scenario2(o3h$a, o3h$b)
scenario3(o3h$a, o3h$b)
```


```{r}
sim <- function(neur, nmult, bxy, bhet, region, nsim=1) {
  args <- as.list(environment()) %>% as_tibble()
  dirs <- here("data", "ld", c("ldAFR", "ldAMR", "ldEAS", "ldEUR", "ldSAS"))
  ld <- organise_ldobj(dirs, region)
  nid <- list(EUR=neur, AFR=neur*nmult, AMR=neur*nmult, EAS=neur*nmult, SAS=neur*nmult)
  bxy <- as.list(rnorm(length(nid), bxy, bhet))
  names(bxy) <- names(nid)
  o <- simss(ld, nid, bxy)
  bind_rows(
    scenario1(o$a, o$b),
    scenario2(o$a, o$b),
    scenario3(o$a, o$b)
  ) %>% bind_cols(args)
}

res <- sim(100000, 0.1, 0.1, 0.1, "1_83991748_84844495")
```


```{r}
regions <- c("12_106958748_109025901", "14_101534307_103012102", "1_83991748_84844495", "2_14335308_16329735", "5_110821144_111981562", "5_140645971_142981248", "6_134244243_136224177", "6_151912703_153094496", "6_42038721_43756169", "7_135591083_136876562")
param <- expand.grid(
  neur=c(100000),
  nmult=c(0.1, 0.5, 1),
  bxy=c(0.1),
  bhet=seq(0, 0.1, 0.2),
  region=regions,
  nsim=1:3
)
param
```


```{r}
future::plan('multicore', workers=60)
opt <- furrr_options(seed=TRUE)
res <- furrr::future_pmap(param, sim, .options=opt, .progress=TRUE) %>% bind_rows()
saveRDS(res, here("results", "scenario_simulations.rds"))
```


## Analysis

```{r}
library(ggplot2)
res <- readRDS(here("results", "scenario_simulations.rds"))
res %>% filter(pop=="All") %>% group_by(scanerio, nmult, bxy, bhet) %>% summarise(het=sum(Qjpval < 0.05)/n(), n=n()) %>%
    ggplot(aes(y=het, x=bhet, color=factor(scanerio))) + geom_line() + facet_wrap(~nmult*bxy)

```


```{r}
ggplot(res, aes(x=pop, y=fstat, fill=as.factor(nmult))) +
geom_violin()
```


## Run 2

```{r}
param <- expand.grid(
  neur=c(100000),
  nmult=c(0.1, 0.5, 1),
  bxy=c(0.5),
  bhet=seq(0, 0.05, 0.01),
  region=regions,
  nsim=20:40
)
future::plan('multicore', workers=60)
opt <- furrr_options(seed=TRUE)
res <- furrr::future_pmap(param, sim, .options=opt, .progress=TRUE) %>% bind_rows()
saveRDS(res, here("results", "scenario_simulations2.rds"))

sp <- split(1:nrow(param), 1:60)
mclapply(1:length(sp), \(x){
    l <- list()
    for(i in sp[[x]]) {
        l[[i]] <- do.call(sim, param[i,])
    }
    l <- bind_rows(l)
    saveRDS(l, here("results", paste0("scenario_simulations2_", x, ".rds")))
}, mc.cores=60)


```


```{r}
res <- lapply(list.files(here("results"), pattern="scenario_simulations2_", full.name=T), \(x) tryCatch(readRDS(x), error=\(e) return(NULL))) %>% bind_rows()
dim(res)

library(ggplot2)
res %>% filter(pop=="All") %>% group_by(scanerio, nmult, bxy, bhet) %>% summarise(het=sum(Qjpval < 0.05)/n(), n=n()) %>%
    ggplot(aes(y=het, x=bhet, color=factor(scanerio))) + geom_line() + facet_wrap(~nmult*bxy)


```

